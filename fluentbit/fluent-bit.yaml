service:
  log_level: info
parsers:
  - name: docker_log_parser
    format: json
    time_key: time
    time_format: "%Y-%m-%dT%H:%M:%S.%L"
    time_keep: false
  - name: kiba_log_parser
    format: json
    time_key: date
    time_format: "%Y-%m-%dT%H:%M:%S.%L"
    time_keep: false
pipeline:
  inputs:
    - name: tail
      path: /var/lib/docker/containers/*/*.log
      parser: docker_log_parser
      tag: docker_logs
      multiline.parser: docker
  outputs:
    - name: opensearch
      match: "*"
      host: ${OPENSEARCH_URL}
      port: 443
      tls: "On"
      logstash_format: "On"
      suppress_type_name: "On"
  # # Testing only
  # inputs:
  #   - name: dummy
  #     dummy: |
  #       {"log": "{\"date\":\"2022-04-21T17:53:48.739537\",\"path\":\"/Users/krishan/Projects/nftoftheday/.env/lib/python3.9/site-packages/core/logging.py\",\"function\":\"api\",\"line\":142,\"message\":\"\",\"level\":\"INFO\",\"logger\":\"api\",\"format\":\"KIBA_API_1\",\"name\":\"notd-api\",\"version\":\"local\",\"environment\":\"dev\",\"requestId\":null,\"apiAction\":\"MESSAGE\",\"apiPath\":\"CMD\",\"apiQuery\":\"a=1&b=2\",\"apiResponse\":\"\",\"apiDuration\":\"\"}"}
  #     tag: docker_logs
  #   - name: dummy
  #     dummy: |
  #       {"log": "{\"time_iso8601\":\"2022-05-19T11:05:14+00:00\",\"request_id\":\"878d3011fbf2fa76aebc4fd40a3d1e89\",\"request_method\":\"GET\",\"uri\":\"/index.html\",\"query_string\":\"\",\"status\":\"200\",\"request_time\":\"0.000\",\"request_length\":\"73\",\"remote_addr\":\"172.17.0.1\",\"remote_user\":\"\",\"remote_port\":\"64588\",\"scheme\":\"http\",\"http_host\":\"localhost\",\"http_referrer\":\"\",\"http_user_agent\":\"curl/7.79.1\",\"bytes_sent\":\"868\",\"format\":\"KIBA_NGINX_1\"}"}
  #     tag: docker_logs
  # outputs:
  #   - name: es
  #     match: "*"
  #     host: elasticsearch
  #     suppress_type_name: "On"
  filters:
    # Extract log fields (docker wraps logs in {"log": "<msg>", ...})
    - name: parser
      match: docker_logs
      parser: kiba_log_parser
      key_name: log
      preserve_key: "Off"
      reserve_data: "On"
    - name: rewrite_tag
      match: docker_logs
      rule: $format ^(KIBA_NGINX_[A-Z0-9_]+)$ "docker_logs.kiba.nginx" false
    - name: rewrite_tag
      match: docker_logs
      rule: $format ^(KIBA_[A-Z0-9_]+)$ "docker_logs.kiba" false
    # Configure nginx logs
    - name: lua
      match: docker_logs.kiba.nginx
      script: nginx.lua
      call: parse
    # Add tag to all records (for debugging log processing)
    - name: lua
      match: "*"
      script: util.lua
      call: append_tag
